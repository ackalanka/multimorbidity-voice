# Voice Biomarker Extraction Pipeline
A modular toolkit for extracting acoustic features from voice recordings, optimized for medical machine learning research with specialized cardiovascular biomarkers.

![Python Version](https://img.shields.io/badge/python-3.12-blue.svg)
![License](https://img.shields.io/badge/license-MIT-green.svg)

## Table of Contents
- [Features](#features)
- [Architecture](#architecture)
- [Installation](#installation)
- [Usage](#usage)
- [Configuration](#configuration)
- [Technical Specifications](#technical-specifications)
- [Data Requirements](#data-requirements)
- [Output Format](#output-format)
- [Cardiovascular Features](#cardiovascular-features)
- [Troubleshooting](#troubleshooting)
- [Contributing](#contributing)
- [License](#license)
- [Contact](#contact)

## Features

### Modular Architecture
- **Separate MFCC and Praat pipelines** for flexible feature selection
- Independent execution allows targeted feature extraction
- Consistent preprocessing and metadata handling across modules

### Audio Processing Pipeline
- Automatic voice activity detection
- Noise reduction using spectral gating
- Pre-emphasis filtering and signal normalization
- Quality metrics and validation

### MFCC Features (mfcconly.py)
- **Configurable MFCC coefficients** (default: 72 coefficients)
- **Statistical measures**: mean, std, kurtosis, skewness, max, min, range
- **Delta features**: First and second derivatives (delta, delta-delta)
- **Comprehensive statistics**: 864 total MFCC-derived features

### Praat Features (praatonly.py)
- **Traditional voice metrics**: Jitter, shimmer, F0 statistics, HNR
- **Formant analysis**: F1/F2 means, standard deviations, dispersion
- **Cardiovascular-specific features**: 25+ specialized biomarkers
- **Advanced vocal health metrics**: Stability, tremor, breathiness indices

### Advanced Functionality
- Multiprocessing support for batch processing
- Automatic metadata extraction from structured filenames
- Comprehensive error logging and quality assessment
- Robust error handling with partial feature recovery

## Architecture

The pipeline consists of two independent modules:

```
voice-biomarker-pipeline/
├── mfcconly.py          # MFCC feature extraction
├── praatonly.py         # Praat/prosodic feature extraction
├── data/
│   └── raw/            # Input WAV files
├── voice_features.csv  # Output (generated by each script)
└── feature_extraction.log
```

**Key Design Principles:**
- **Modularity**: Extract MFCC or Praat features independently
- **Consistency**: Identical preprocessing and metadata handling
- **Scalability**: Multiprocessing support for large datasets
- **Robustness**: Comprehensive error handling and validation

## Installation

### Requirements
- **Python 3.12 only** (strict requirement for dependency compatibility)
- Windows/Linux/MacOS support

### Steps
1. **Clone repository:**
   ```bash
   git clone https://github.com/ackalanka/multimorbidity-voice
   cd multimorbidity-voice
   ```

2. **Create virtual environment:**
   ```bash
   python -m venv venv
   source venv/bin/activate  # Linux/MacOS
   venv\Scripts\activate     # Windows
   ```

3. **Install dependencies:**
   ```bash
   pip install -r requirements.txt
   ```

### Dependencies
- `librosa`: MFCC extraction and audio processing
- `parselmouth`: Praat integration for prosodic features
- `noisereduce`: Spectral noise reduction
- `numpy`, `pandas`, `scipy`: Numerical computing
- `multiprocessing`: Parallel processing

## Usage

### Input Preparation
1. **Place WAV files** in `data/raw/` directory
2. **Follow naming convention**: `[ID]-[Gender]-[Age]-[DD.MM.YYYY]-[HH]-[MM].wav`
   - Example: `2303-F-30-29.11.2023-20-08.wav`

### MFCC Feature Extraction
```bash
python mfcconly.py
```
**Output**: 864 MFCC-derived features including:
- 72 MFCC coefficients with statistical measures (504 features)
- Delta coefficients (360 features)
- Metadata and quality metrics

### Praat Feature Extraction
```bash
python praatonly.py
```
**Output**: 25+ prosodic and cardiovascular features including:
- Traditional voice metrics (jitter, shimmer, F0, HNR)
- Formant analysis and dispersion measures
- Cardiovascular-specific biomarkers
- Voice stability and quality indices

### Combined Analysis
Run both scripts to get comprehensive feature sets:
```bash
python mfcconly.py
python praatonly.py
```

## Configuration

### Common Parameters (both scripts)
| Parameter | Default Value | Description |
|-----------|---------------|-------------|
| `INPUT_DIR` | `data/raw` | Input directory for WAV files |
| `OUTPUT_CSV` | `voice_features.csv` | Output CSV filename |
| `SAMPLE_RATE` | `16000` | Target sampling rate (Hz) |
| `MIN_VOICE_DURATION` | `0.5` | Minimum valid voice duration (sec) |
| `NOISE_REDUCTION_AGGRESSION` | `1.5` | Noise reduction intensity (0-2) |

### MFCC-Specific Parameters
| Parameter | Default Value | Description |
|-----------|---------------|-------------|
| `N_MFCC` | `72` | Number of MFCC coefficients |

### Praat-Specific Parameters
| Parameter | Default Value | Description |
|-----------|---------------|-------------|
| `USE_PARSELMOUTH` | `True` | Enable Praat feature extraction |
| `MIN_PARSELMOUTH_DURATION` | `0.3` | Minimum duration for Praat analysis |

## Technical Specifications

### Audio Processing
- **Resampling**: Librosa with anti-aliasing
- **Noise Reduction**: Spectral gating via noisereduce
- **Voice Activity Detection**: Librosa trim with 25dB threshold
- **Pre-emphasis**: Coefficient 0.97

### MFCC Parameters
- **Mel Bands**: 128 (frequency range: 50-8000 Hz)
- **FFT**: 2048-point with 512 hop length
- **Coefficients**: Configurable (default: 72)
- **Statistics**: 7 measures per coefficient (mean, std, kurtosis, skewness, max, min, range)

### Praat Parameters
- **F0 Range**: 75-600 Hz
- **Frame Length**: 25ms with 2.5ms shift
- **Formant Analysis**: Up to 5 formants, 5000 Hz ceiling
- **Harmonicity**: 10ms window, 500 Hz ceiling

## Data Requirements

### Input Format
- **File Type**: 16-bit PCM WAV files
- **Channels**: Mono (automatically converted)
- **Duration**: 1-5 seconds recommended
- **Sample Rate**: ≥16kHz (resampled if needed)

### File Naming Convention
**Critical**: Filenames must follow exact pattern for metadata extraction:
```
<ID>-<Gender>-<Age>-<DD.MM.YYYY>-<HH>-<MM>.wav
```

**Examples**:
- `2303-F-30-29.11.2023-20-08.wav`
- `1457-M-65-15.06.2023-14-30.wav`

**Parsed Metadata Fields**:
- `patient_id`: Numeric participant identifier
- `gender`: F (female) or M (male)
- `age`: Age in years (0-120 range validated)
- `recording_date`: ISO format date (YYYY-MM-DD)
- `recording_time`: 24-hour format time (HH:MM:SS)

## Output Format

### MFCC Output (mfcconly.py)
**Total Features**: ~870 columns

**Column Groups**:
1. **Metadata** (8 columns): patient_id, gender, age, recording_date, recording_time, filename, durations
2. **MFCC Features** (504 columns): mfcc_01_mean to mfcc_72_range
3. **Delta Features** (360 columns): delta_01_mean to delta2_72_range
4. **Quality Metrics** (3 columns): snr_db, trim_start, trim_end

### Praat Output (praatonly.py)
**Total Features**: ~35 columns

**Column Groups**:
1. **Metadata** (8 columns): Same as MFCC output
2. **Traditional Voice Metrics** (10 columns):
   - Jitter: local, ppq5
   - Shimmer: local, apq11  
   - F0: mean, std, entropy, range, IQR
   - HNR: mean, std, min, max
3. **Formant Features** (6 columns):
   - F1/F2: mean, std
   - Formant dispersion, centralization ratio
4. **Cardiovascular Biomarkers** (15 columns):
   - Voice tremor, stability index
   - Maximum phonation time
   - Intensity dynamics (mean, std, range)
   - Pause metrics (rate, duration, ratio)
   - Speech rate and rhythm
   - Breathiness measures
5. **Quality Metrics** (5 columns): snr_db, trim times, parselmouth_status, praat_errors

## Cardiovascular Features

The Praat module includes specialized features for cardiovascular health assessment:

### Voice Stability Indicators
- **Voice Tremor**: Pitch frequency modulation coefficient
- **Vocal Stability Index**: Combined pitch and amplitude stability measure
- **Rhythm Variability**: Inter-syllable interval variability

### Breathing and Phonation
- **Maximum Phonation Time**: Estimated from continuous voiced segments  
- **Pause Metrics**: Rate, mean duration, time ratio
- **Breathiness Index**: HNR-based breathiness measure
- **Spectral Noise**: High-frequency energy ratio

### Formant Dynamics
- **Formant Centralization Ratio**: Vowel space area indicator
- **F1/F2 Statistics**: Mean and variability measures
- **Formant Dispersion**: Average formant spacing

### Intensity and Prosody
- **Intensity Dynamics**: Mean, standard deviation, range
- **Syllable Rate**: Estimated speech rate
- **Spectral Tilt**: Frequency-dependent power distribution

## Troubleshooting

### Common Issues

**No WAV files found:**
- Verify files are in `data/raw/` directory
- Check file extensions (.wav, lowercase)
- Ensure proper file naming convention

**Praat Command Errors:**
- Check minimum audio duration (0.3s for Praat features)
- Verify audio quality (avoid silent/noisy recordings)
- Review `praat_errors` column in output for specific issues

**Memory Issues:**
- Reduce parallel processes: `Pool(cpu_count()//2)`
- Process files in smaller batches
- Check available system memory

**MFCC Configuration:**
- Reduce `N_MFCC` if memory constraints exist
- Adjust mel filter parameters for specific applications

### Logging and Debugging
- **Detailed logs**: `feature_extraction.log`
- **Console output**: Real-time progress and errors
- **Debug mode**: Set `logging.basicConfig(level=logging.DEBUG)`

## Contributing

We welcome contributions! Please follow these guidelines:

### Reporting Issues
- Use GitHub Issues with detailed error logs
- Include sample files and system information
- Specify which module (MFCC/Praat) is affected

### Development Guidelines
1. **Branch naming**: `feature/your-feature` or `fix/issue-description`
2. **Code standards**: PEP8 compliance, type hints, docstrings
3. **Testing**: Add tests for new features
4. **Documentation**: Update README for new features

### Feature Requests
- Describe medical/research use case
- Provide implementation suggestions
- Consider cardiovascular relevance

## License
MIT License - See LICENSE for details.

## Acknowledgments
- **Librosa**: MFCC extraction and audio processing
- **Parselmouth**: Praat integration for prosodic analysis
- **noisereduce**: Spectral noise reduction
- **SciPy ecosystem**: Numerical computing foundation

## Contact
**Akalanka Ranasinghe**
- GitHub: [@ackalanka](https://github.com/ackalanka)
- Email: akalankar98@gmail.com

---

*This pipeline is designed for medical machine learning research. Ensure proper ethical approval and data handling protocols when working with patient voice data.*